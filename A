local serverURL = "https://aca81e58-d6f7-45fa-b644-30bbaad780a5-00-3oqlxf9wb5ogo.picard.replit.dev/"

local HttpService = game:GetService("HttpService")
local player = game.Players.LocalPlayer

-- Crear Tool solo si no existe
local tool = player.Backpack:FindFirstChild("Bloqueador") or Instance.new("Tool")
tool.Name = "Bloqueador"
tool.RequiresHandle = false
tool.Parent = player.Backpack

local bloquesLocales = {}

local function posToKey(pos)
    local x = math.floor(pos.X / 4 + 0.5) * 4
    local y = math.floor(pos.Y / 4 + 0.5) * 4
    local z = math.floor(pos.Z / 4 + 0.5) * 4
    return string.format("%d_%d_%d", x, y, z)
end

local function hayBloqueEnPos(pos)
    local key = posToKey(pos)
    return bloquesLocales[key] ~= nil
end

local function colocarBloque(pos)
    local x = math.floor(pos.X / 4 + 0.5) * 4
    local y = math.floor(pos.Y / 4 + 0.5) * 4
    local z = math.floor(pos.Z / 4 + 0.5) * 4
    local posRedondeada = Vector3.new(x, y, z)

    local key = posToKey(posRedondeada)
    if bloquesLocales[key] then
        return
    end

    local bloque = Instance.new("Part")
    bloque.Size = Vector3.new(4, 4, 4)
    bloque.Anchored = true
    bloque.CanCollide = true
    bloque.Position = posRedondeada
    bloque.Color = Color3.fromRGB(255, 255, 0)
    bloque.Parent = workspace

    bloquesLocales[key] = bloque
end

local function enviarBloque(pos)
    local body = HttpService:JSONEncode({
        x = pos.X,
        y = pos.Y,
        z = pos.Z,
        color = "amarillo"
    })

    local success, res = pcall(function()
        return syn.request({
            Url = serverURL.."/colocar",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    end)

    if not success then
        warn("Error al enviar bloque:", res)
    end
end

tool.Activated:Connect(function()
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local posJugador = hrp.Position
    colocarBloque(posJugador)
    enviarBloque(posJugador)
end)

task.spawn(function()
    while true do
        local success, res = pcall(function()
            return syn.request({
                Url = serverURL.."/bloques",
                Method = "GET"
            })
        end)

        if success and res.StatusCode == 200 then
            local ok, lista = pcall(function()
                return HttpService:JSONDecode(res.Body)
            end)

            if ok and type(lista) == "table" then
                for _, b in ipairs(lista) do
                    local pos = Vector3.new(b.x, b.y, b.z)
                    if not hayBloqueEnPos(pos) then
                        colocarBloque(pos)
                    end
                end
            end
        end

        task.wait(3)
    end
end)
